<UserControl x:Class="RecordingsHelper.WPF.Views.AdvancedRedactView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:viewmodels="clr-namespace:RecordingsHelper.WPF.ViewModels"
             xmlns:converters="clr-namespace:RecordingsHelper.WPF.Converters"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance Type=viewmodels:AdvancedRedactViewModel}">
    
    <UserControl.Resources>
        <converters:EnumToBoolConverter x:Key="EnumToBoolConverter"/>
        <converters:ZeroToVisibilityConverter x:Key="ZeroToVisibilityConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:ActionToTextConverter x:Key="ActionToTextConverter"/>
    </UserControl.Resources>
    
    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="32">
            <!-- Header -->
            <Grid Margin="0,0,0,24">
                <Button Style="{StaticResource MaterialDesignIconForegroundButton}"
                        Command="{Binding DataContext.NavigateToHomeCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                        VerticalAlignment="Top"
                        HorizontalAlignment="Left"
                        ToolTip="Back to Home">
                    <materialDesign:PackIcon Kind="ArrowLeft" Width="24" Height="24"/>
                </Button>
                
                <TextBlock Text="Advanced Redaction (Transcript-based)"
                           Style="{StaticResource MaterialDesignHeadline4TextBlock}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"/>
            </Grid>

            <!-- File Loading Section -->
            <materialDesign:Card Padding="16" Margin="0,0,0,16">
                <StackPanel>
                    <TextBlock Text="Load Files" 
                               FontWeight="Bold" 
                               FontSize="16"
                               Margin="0,0,0,16"/>
                    
                    <!-- Audio File -->
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <materialDesign:PackIcon Kind="Microphone" 
                                                Grid.Column="0"
                                                VerticalAlignment="Center"
                                                Margin="0,0,8,0"/>
                        <TextBlock Grid.Column="1"
                                   VerticalAlignment="Center"
                                   Text="{Binding LoadedAudioPath, TargetNullValue='No audio file loaded'}"
                                   TextTrimming="CharacterEllipsis"/>
                        <Button Grid.Column="2"
                                Content="Load Audio"
                                Command="{Binding LoadAudioFileCommand}"
                                Style="{StaticResource MaterialDesignFlatButton}"/>
                    </Grid>

                    <!-- Insights File -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <materialDesign:PackIcon Kind="FileDocument" 
                                                Grid.Column="0"
                                                VerticalAlignment="Center"
                                                Margin="0,0,8,0"/>
                        <TextBlock Grid.Column="1"
                                   VerticalAlignment="Center"
                                   Text="{Binding LoadedInsightsPath, TargetNullValue='No insights file loaded'}"
                                   TextTrimming="CharacterEllipsis"/>
                        <Button Grid.Column="2"
                                Content="Load Insights"
                                Command="{Binding LoadInsightsFileCommand}"
                                Style="{StaticResource MaterialDesignFlatButton}"/>
                    </Grid>

                    <Button Content="Clear All Files"
                            Command="{Binding UnloadAllCommand}"
                            Style="{StaticResource MaterialDesignOutlinedButton}"
                            HorizontalAlignment="Right"
                            Margin="0,16,0,0"/>
                </StackPanel>
            </materialDesign:Card>

            <!-- Transcript Selection Section -->
            <materialDesign:Card Padding="16" Margin="0,0,0,16">
                <StackPanel>
                    <Grid Margin="0,0,0,12">
                        <TextBlock Text="Transcript Segments" 
                                   FontWeight="Bold" 
                                   FontSize="16"
                                   VerticalAlignment="Center"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <TextBox Width="180" Margin="0,0,8,0"
                                     VerticalAlignment="Center"
                                     materialDesign:HintAssist.Hint="Search..."
                                     Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"/>
                            <Button Content="Select All"
                                    Command="{Binding SelectAllCommand}"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    Margin="0,0,8,0"/>
                            <Button Content="Deselect All"
                                    Command="{Binding DeselectAllCommand}"
                                    Style="{StaticResource MaterialDesignFlatButton}"/>
                        </StackPanel>
                    </Grid>

                    <ScrollViewer MaxHeight="400" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding FilteredTranscriptItems}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <materialDesign:Card Margin="0,0,0,8" Padding="12">
                                        <Grid MouseLeftButtonUp="SegmentCard_Click" Cursor="Hand">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <!-- Selection and ID -->
                                            <Grid Grid.Row="0" Margin="0,0,0,8">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <CheckBox Grid.Column="0" IsChecked="{Binding IsSelected}"
                                                         VerticalAlignment="Center"
                                                         Margin="0,0,8,0"/>
                                                         
                                                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                                                    <TextBlock Text="Segment #" FontWeight="Bold"/>
                                                    <TextBlock Text="{Binding Id}" FontWeight="Bold" Margin="4,0,16,0"/>
                                                    <materialDesign:PackIcon Kind="Account" Margin="0,0,4,0" VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding SpeakerId, StringFormat='Speaker {0}'}" Opacity="0.7" Margin="0,0,16,0"/>
                                                    <materialDesign:PackIcon Kind="Clock" Margin="0,0,4,0" VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding TimeRange}" Opacity="0.7"/>
                                                </StackPanel>
                                                
                                                <!-- Action Toggle (icon-only, smaller) -->
                                                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0,0,0">
                                                    <ToggleButton IsChecked="{Binding IsRemoveAction, Mode=TwoWay}"
                                                                  Width="32" Height="32"
                                                                  ToolTip="Toggle Mute/Remove">
                                                        <materialDesign:PackIcon Kind="BackspaceOutline" Width="20" Height="20"/>
                                                    </ToggleButton>
                                                    <TextBlock Text="{Binding SelectedAction, Converter={StaticResource ActionToTextConverter}}"
                                                               Margin="8,0,0,0" VerticalAlignment="Center" FontWeight="SemiBold"/>
                                                </StackPanel>
                                            </Grid>
                                            <!-- Transcript Text -->
                                            <TextBlock Grid.Row="1"
                                                      Text="{Binding Text}"
                                                      TextWrapping="Wrap"
                                                      Margin="32,0,0,8"/>
                                            <!-- Confidence -->
                                            <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="32,0,0,0">
                                                <materialDesign:PackIcon Kind="ChartLine" Width="14" Height="14" Margin="0,0,4,0" Opacity="0.6" VerticalAlignment="Center"/>
                                                <TextBlock Text="{Binding Confidence, StringFormat='Confidence: {0:P1}'}" FontSize="12" Opacity="0.6"/>
                                            </StackPanel>
                                        </Grid>
                                    </materialDesign:Card>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Empty State -->
                    <TextBlock Text="No transcript segments loaded. Please load an insights JSON file."
                              TextAlignment="Center"
                              Opacity="0.6"
                              Margin="0,32,0,0"
                              Visibility="{Binding TranscriptItems.Count, Converter={StaticResource ZeroToVisibilityConverter}}"/>
                </StackPanel>
            </materialDesign:Card>

            <!-- Process Section -->
            <materialDesign:Card Padding="16">
                <StackPanel>
                    <Button Content="Process Redactions"
                            Command="{Binding ProcessRedactionsCommand}"
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            HorizontalAlignment="Center"
                            Padding="32,8"/>

                    <!-- Status Message -->
                    <TextBlock Text="{Binding StatusMessage}"
                              TextAlignment="Center"
                              Margin="0,16,0,0"
                              FontWeight="Bold"
                              Visibility="{Binding StatusMessage, Converter={StaticResource NullToVisibilityConverter}}"/>

                    <!-- Processing Indicator -->
                    <ProgressBar IsIndeterminate="True"
                                Margin="0,16,0,0"
                                Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}}"/>
                </StackPanel>
            </materialDesign:Card>
        </StackPanel>
    </ScrollViewer>
</UserControl>
